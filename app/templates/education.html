{% extends 'base.html' %}

{% block title %}Education - The Journey{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Education Page Specific Styles */
    .education-container {
        margin-bottom: 30px;
    }
    
    .page-title {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 25px;
        color: white;
        text-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
    }
    
    .subjects-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .subject-card {
        position: relative;
        background: linear-gradient(135deg, rgba(26, 32, 48, 0.95), rgba(35, 41, 70, 0.95));
        border-radius: 15px;
        padding: 25px;
        width: 100%;
        border: 2px solid rgba(59, 130, 246, 0.4);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .subject-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3), 0 0 15px rgba(99, 102, 241, 0.4);
        border-color: rgba(99, 102, 241, 0.6);
    }
    
    .subject-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.2), transparent 70%);
        z-index: 0;
    }
    
    .subject-header {
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        z-index: 1;
    }
    
    .subject-name {
        font-size: 1.4rem;
        font-weight: bold;
        color: white;
    }
    
    .subject-progress-text {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .subject-progress-container {
        position: relative;
        height: 10px;
        background: rgba(15, 23, 42, 0.7);
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 20px;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .subject-progress-bar {
        position: absolute;
        height: 100%;
        left: 0;
        background: linear-gradient(90deg, #3b82f6, #6366f1);
        border-radius: 5px;
        transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
    }
    
    .subject-progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            90deg,
            transparent 0%,
            rgba(255, 255, 255, 0.4) 50%,
            transparent 100%
        );
        animation: shimmer 2s infinite;
        transform: translateX(-100%);
    }
    
    .subject-syllabus {
        position: relative;
        z-index: 1;
    }
    
    .syllabus-title {
        font-size: 1rem;
        font-weight: bold;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 10px;
    }
    
    .syllabus-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .syllabus-item {
        display: flex;
        flex-direction: column;
        padding: 8px 0;
        margin-bottom: 5px;
        color: rgba(255, 255, 255, 0.7);
        transition: all 0.3s ease;
    }
    
    .syllabus-item:not(:last-child) {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .syllabus-checkbox {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 2px solid rgba(59, 130, 246, 0.6);
        margin-right: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .syllabus-item.completed .syllabus-checkbox {
        background-color: rgba(59, 130, 246, 0.8);
        border-color: transparent;
    }
    
    .syllabus-item.completed .syllabus-checkbox::after {
        content: '✓';
        color: white;
        font-size: 0.8rem;
    }
    
    .syllabus-item.completed .syllabus-text {
        text-decoration: line-through;
        opacity: 0.6;
    }
    
    .study-section {
        margin-top: 40px;
        background: linear-gradient(135deg, rgba(26, 32, 48, 0.95), rgba(35, 41, 70, 0.95));
        border-radius: 20px;
        padding: 25px;
        border: 2px solid rgba(59, 130, 246, 0.4);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
    }
    
    .study-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.15), transparent 70%);
        z-index: 0;
    }
    
    .study-section-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 20px;
        color: white;
        position: relative;
        z-index: 1;
    }
    
    .study-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 30px;
        position: relative;
        z-index: 1;
    }
    
    .study-form {
        padding: 20px;
        background: rgba(15, 23, 42, 0.4);
        border-radius: 10px;
        border: 1px solid rgba(59, 130, 246, 0.3);
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
    }
    
    .form-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 5px;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .form-input {
        width: 100%;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid rgba(59, 130, 246, 0.4);
        background: rgba(15, 23, 42, 0.6);
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        outline: none;
        border-color: rgba(99, 102, 241, 0.8);
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
    }
    
    .form-select {
        width: 100%;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid rgba(59, 130, 246, 0.4);
        background: rgba(15, 23, 42, 0.6);
        color: white;
        font-size: 1rem;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23ffffff' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 20px;
    }
    
    .form-submit {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .form-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .form-submit::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.2),
            transparent
        );
        transition: all 0.6s;
    }
    
    .form-submit:hover::before {
        left: 100%;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    /* Animation for cards on load */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .subject-card {
        animation: fadeInUp 0.6s ease forwards;
        opacity: 0;
    }
    
    .subject-card:nth-child(1) { animation-delay: 0.1s; }
    .subject-card:nth-child(2) { animation-delay: 0.3s; }
    .subject-card:nth-child(3) { animation-delay: 0.5s; }
    
    /* Add Subject & Syllabus Styles */
    .add-section {
        margin-bottom: 30px;
    }
    
    .add-button {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(99, 102, 241, 0.8));
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .add-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
    }
    
    .add-button::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background-image: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0),
            rgba(255, 255, 255, 0.3),
            rgba(255, 255, 255, 0)
        );
        animation: shine 4s infinite;
    }
    
    .add-icon {
        font-size: 1.2rem;
        margin-right: 8px;
        font-weight: bold;
    }
    
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal-content {
        background: linear-gradient(135deg, rgba(26, 32, 48, 0.95), rgba(35, 41, 70, 0.95));
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        border: 2px solid rgba(59, 130, 246, 0.4);
        transform: translateY(20px);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }
    
    .modal-overlay.active .modal-content {
        transform: translateY(0);
        opacity: 1;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal-title {
        color: white;
        margin: 0;
        font-size: 1.5rem;
    }
    
    .close-button {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.8rem;
        cursor: pointer;
        transition: color 0.2s ease;
    }
    
    .close-button:hover {
        color: white;
    }
    
    .modal-tabs {
        display: flex;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .tab-button {
        flex: 1;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        padding: 15px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .tab-button.active {
        color: white;
        font-weight: 600;
    }
    
    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, #3b82f6, #6366f1);
        border-radius: 3px 3px 0 0;
    }
    
    .tab-content {
        padding: 25px;
        animation: fadeIn 0.3s ease;
    }
    
    .tab-content.hidden {
        display: none;
    }
    
    .modal-form .form-submit {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        transition: all 0.3s ease;
    }
    
    .modal-form .form-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    @keyframes shine {
        0% { left: -100%; }
        20% { left: 100%; }
        100% { left: 100%; }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    /* Topic list styles */
    .topics-container {
        margin-top: 20px;
    }
    
    .topic-list {
        list-style-type: none;
        padding: 0;
        margin: 15px 0;
    }
    
    .topic-item {
        display: flex;
        align-items: flex-start;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }
    
    .topic-item:last-child {
        border-bottom: none;
    }
    
    .topic-toggle-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.2rem;
        padding: 0;
        margin-right: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .topic-toggle-btn:hover {
        color: #6366f1;
        transform: scale(1.2);
    }
    
    .topic-item.completed .topic-toggle-btn {
        color: #4ade80;
    }
    
    .topic-item.completed .topic-name {
        text-decoration: line-through;
        color: rgba(255, 255, 255, 0.5);
    }
    
    .topic-info {
        flex: 1;
    }
    
    .topic-name {
        font-weight: 500;
        margin-bottom: 3px;
    }
    
    .topic-description {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
    }
    
    /* Form Styles */
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-control {
        display: block;
        width: 100%;
        padding: 10px 15px;
        background-color: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        color: white;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: rgba(99, 102, 241, 0.5);
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .btn-block {
        display: block;
        width: 100%;
    }
    
    /* Notification System */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 6px;
        color: white;
        font-weight: medium;
        max-width: 300px;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideIn 0.3s ease, fadeOut 0.5s ease 3.5s forwards;
    }
    
    .notification.success {
        background-color: rgba(16, 185, 129, 0.9);
        border-left: 4px solid rgb(4, 120, 87);
    }
    
    .notification.error {
        background-color: rgba(239, 68, 68, 0.9);
        border-left: 4px solid rgb(185, 28, 28);
    }
    
    .notification.warning {
        background-color: rgba(245, 158, 11, 0.9);
        border-left: 4px solid rgb(180, 83, 9);
    }
    
    .notification.info {
        background-color: rgba(59, 130, 246, 0.9);
        border-left: 4px solid rgb(29, 78, 216);
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }
    
    /* Updated Checkbox Styling */
    .syllabus-checkbox {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 2px solid rgba(59, 130, 246, 0.6);
        margin-right: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .syllabus-item.completed .syllabus-checkbox {
        background-color: rgba(59, 130, 246, 0.8);
        border-color: transparent;
    }
    
    .syllabus-item.completed .syllabus-checkbox::after {
        content: '✓';
        color: white;
        font-size: 0.8rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .study-grid {
            grid-template-columns: 1fr;
        }
        
        .modal-content {
            width: 95%;
        }
    }
    
    .syllabus-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 5px 0;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }
    
    .syllabus-header:hover {
        color: rgba(255, 255, 255, 1);
    }
    
    .syllabus-toggle {
        font-size: 0.8rem;
        transition: transform 0.3s ease;
    }
    
    .syllabus-list {
        max-height: 1000px;
        overflow: hidden;
        transition: max-height 0.5s ease;
    }
    
    .syllabus-list.collapsed {
        max-height: 0;
    }
    
    .syllabus-header.collapsed .syllabus-toggle {
        transform: rotate(0deg);
    }
    
    .syllabus-header:not(.collapsed) .syllabus-toggle {
        transform: rotate(90deg);
    }
    
    .topic-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    
    .subtopic-actions {
        display: flex;
        gap: 10px;
    }
    
    .add-subtopic-btn, .toggle-subtopics-btn {
        cursor: pointer;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        transition: all 0.2s ease;
    }
    
    .add-subtopic-btn:hover, .toggle-subtopics-btn:hover {
        color: rgba(99, 102, 241, 1);
        transform: scale(1.2);
    }
    
    .subtopics-container {
        margin: 5px 0 5px 20px;
        overflow: hidden;
        max-height: 1000px;
        transition: max-height 0.4s ease, opacity 0.3s ease;
        opacity: 1;
        background: rgba(15, 23, 42, 0.3);
        border-radius: 8px;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .subtopics-container.collapsed {
        max-height: 0;
        opacity: 0;
        border: none;
    }
    
    .subtopics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: rgba(15, 23, 42, 0.5);
        border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .subtopics-title {
        font-size: 0.9rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .subtopics-count {
        font-size: 0.8rem;
        background: rgba(59, 130, 246, 0.3);
        color: white;
        border-radius: 12px;
        padding: 2px 8px;
    }
    
    .subtopics-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .subtopic-item {
        display: flex;
        align-items: center;
        padding: 6px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
    }
    
    .subtopic-item:hover {
        background: rgba(59, 130, 246, 0.1);
    }
    
    .subtopic-item:last-child {
        border-bottom: none;
    }
    
    .subtopic-checkbox {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        border: 2px solid rgba(59, 130, 246, 0.5);
        margin-right: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    
    .subtopic-item.completed .subtopic-checkbox {
        background-color: rgba(59, 130, 246, 0.6);
        border-color: transparent;
    }
    
    .subtopic-item.completed .subtopic-checkbox::after {
        content: '✓';
        color: white;
        font-size: 0.7rem;
    }
    
    .subtopic-item.completed .subtopic-text {
        text-decoration: line-through;
        opacity: 0.7;
    }
    
    .subtopic-text {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .topic-progress-container {
        position: relative;
        height: 4px;
        background: rgba(15, 23, 42, 0.5);
        border-radius: 2px;
        overflow: hidden;
        margin: 5px 0 5px 20px;
        width: calc(100% - 20px);
    }
    
    .topic-progress-bar {
        position: absolute;
        height: 100%;
        left: 0;
        background: linear-gradient(90deg, rgba(99, 102, 241, 0.7), rgba(99, 102, 241, 0.9));
        border-radius: 2px;
        transition: width 0.5s cubic-bezier(0.22, 1, 0.36, 1);
    }
    
    .no-subtopics {
        font-style: italic;
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.85rem;
        padding: 10px 12px;
        text-align: center;
        max-height: 100px;
        transition: max-height 0.5s ease, opacity 0.3s ease;
        opacity: 1;
    }
    
    .subtopics-wrapper {
        margin: 10px 0 5px 20px;
        background: rgba(15, 23, 42, 0.3);
        border-radius: 8px;
        border: 1px solid rgba(59, 130, 246, 0.2);
        overflow: hidden;
        max-height: 1000px;
        transition: max-height 0.5s ease, opacity 0.3s ease;
        opacity: 1;
    }
    
    .subtopics-wrapper.collapsed {
        max-height: 0;
        opacity: 0;
        border: none;
    }
    
    .no-subtopics.collapsed {
        max-height: 0;
        opacity: 0;
        overflow: hidden;
    }
    
    .no-subtopics {
        font-style: italic;
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.85rem;
        padding: 10px 12px;
        text-align: center;
        max-height: 100px;
        transition: max-height 0.5s ease, opacity 0.3s ease;
        opacity: 1;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .chart-controls {
        display: flex;
        gap: 5px;
    }
    
    .chart-btn {
        padding: 5px 10px;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: rgba(255, 255, 255, 0.8);
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .chart-btn:hover {
        background: rgba(30, 41, 59, 0.8);
        border-color: rgba(59, 130, 246, 0.5);
    }
    
    .chart-btn.active {
        background: rgba(59, 130, 246, 0.2);
        border-color: rgba(59, 130, 246, 0.8);
        color: white;
    }
    
    /* Add styles for no-data message */
    .no-data-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: rgba(255, 255, 255, 0.6);
        font-size: 1.1rem;
        padding: 20px;
        border: 1px dashed rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        background: rgba(15, 23, 42, 0.3);
    }
    
    /* Chart loading state */
    .chart-container.loading {
        position: relative;
        min-height: 200px;
    }
    
    .chart-container.loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1;
    }
    
    .chart-container.loading::before {
        content: 'Loading...';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        z-index: 2;
    }
    
    /* Chart styles */
    .study-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 30px;
        position: relative;
        z-index: 1;
    }
    
    .chart-container {
        position: relative;
        background: rgba(15, 23, 42, 0.4);
        border-radius: 10px;
        border: 1px solid rgba(59, 130, 246, 0.3);
        padding: 20px 20px 80px 20px; /* Increased bottom padding to 80px */
        height: 520px; /* Increased height to accommodate bottom padding */
        min-width: 500px; /* Added minimum width */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        margin: 0;
    }
    
    .chart-controls {
        display: flex;
        gap: 8px;
    }
    
    .chart-btn {
        padding: 6px 12px;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: rgba(255, 255, 255, 0.8);
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .chart-btn:hover {
        background: rgba(30, 41, 59, 0.8);
        border-color: rgba(59, 130, 246, 0.5);
    }
    
    .chart-btn.active {
        background: rgba(59, 130, 246, 0.2);
        border-color: rgba(59, 130, 246, 0.8);
        color: white;
    }
    
    /* Add styles for no-data message */
    .no-data-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: rgba(255, 255, 255, 0.6);
        font-size: 1.1rem;
        padding: 20px;
        border: 1px dashed rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        background: rgba(15, 23, 42, 0.3);
    }
    
    /* Chart loading state */
    .chart-container.loading {
        position: relative;
        min-height: 200px;
    }
    
    .chart-container.loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1;
    }
    
    .chart-container.loading::before {
        content: 'Loading...';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        z-index: 2;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1024px) {
        .study-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-container {
            height: 480px; /* Increased from 450px */
            min-width: auto; /* Allow it to shrink on mobile */
            width: 100%;
            padding: 20px 20px 80px 20px; /* Ensure consistent padding on mobile */
        }
    }
    
    /* Month navigation */
    .month-nav {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 15px;
        padding: 5px 0;
        background: rgba(15, 23, 42, 0.3);
        border-radius: 6px;
    }
    
    .month-nav-btn {
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid rgba(59, 130, 246, 0.4);
        color: rgba(255, 255, 255, 0.9);
        border-radius: 4px;
        padding: 4px 10px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .month-nav-btn:hover {
        background: rgba(59, 130, 246, 0.4);
    }
    
    .current-month-display {
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.9);
        padding: 0 15px;
        font-weight: 500;
    }
    
    /* Add styles for delete buttons */
    .delete-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 3px 6px;
        border-radius: 4px;
    }
    
    .delete-btn:hover {
        color: rgba(239, 68, 68, 0.9);
        background: rgba(239, 68, 68, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-content">
    <div class="education-container">
        <h1 class="page-title">Education Tracker</h1>
        
        <!-- Subjects Grid -->
        <div class="subjects-grid">
            {% for subject in subjects %}
            <div class="subject-card">
                <div class="subject-header">
                    <div class="subject-name">{{ subject.name }}</div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="subject-progress-text">{{ subject.progress }}% Complete</div>
                        <form action="{{ url_for('journey.delete_subject', subject_id=subject.id) }}" method="POST" style="margin: 0;" onsubmit="return confirm('Are you sure you want to delete this subject and all its topics and subtopics? This cannot be undone.');">
                            {{ form.hidden_tag() }}
                            <button type="submit" class="delete-btn" title="Delete subject">🗑️</button>
                        </form>
                    </div>
                </div>
                
                <div class="subject-progress-container">
                    <div class="subject-progress-bar" style="width: {{ subject.progress }}% !important;"></div>
                </div>
                
                <div class="subject-syllabus">
                    <div class="syllabus-header" onclick="toggleSyllabus(this)">
                        <div class="syllabus-title">Syllabus</div>
                        <div class="syllabus-toggle">▶</div>
                    </div>
                    <ul class="syllabus-list">
                        {% for topic in subject.topics %}
                        <li class="syllabus-item {% if topic.is_completed %}completed{% endif %}" 
                            data-subject="{{ subject.id }}" 
                            data-topic-id="{{ topic.id }}">
                            <div class="topic-header">
                                <div class="syllabus-checkbox" data-topic-id="{{ topic.id }}" data-completed="{{ topic.is_completed|lower }}"></div>
                                <span class="syllabus-text">{{ topic.name }}</span>
                                <div class="subtopic-actions">
                                    <span class="add-subtopic-btn" onclick="showAddSubtopicModal('{{ topic.id }}', '{{ topic.name }}', event)">+</span>
                                    <span class="toggle-subtopics-btn" onclick="toggleSubtopicsDropdown(this, event)">▶</span>
                                    <form action="{{ url_for('journey.delete_topic', topic_id=topic.id) }}" method="POST" style="display: inline; margin: 0;" onsubmit="return confirm('Are you sure you want to delete this topic and all its subtopics? This cannot be undone.');">
                                        {{ form.hidden_tag() }}
                                        <button type="submit" class="delete-btn" title="Delete topic" onclick="event.stopPropagation();">🗑️</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="topic-progress-container">
                                <div class="topic-progress-bar" style="width: {{ topic.progress }}%"></div>
                            </div>
                            
                            {% if topic.subtopics|length > 0 %}
                            <div class="subtopics-wrapper collapsed">
                                <div class="subtopics-header">
                                    <span class="subtopics-title">Subtopics ({{ topic.subtopics|length }})</span>
                                </div>
                                
                                <div class="subtopics-list-container">
                                    <ul class="subtopics-list">
                                        {% for subtopic in topic.subtopics %}
                                        <li class="subtopic-item {% if subtopic.is_completed %}completed{% endif %}" 
                                            data-subtopic-id="{{ subtopic.id }}">
                                            <div class="subtopic-checkbox" onclick="toggleSubtopic('{{ subtopic.id }}', this, event)" data-completed="{{ subtopic.is_completed|lower }}"></div>
                                            <span class="subtopic-text">{{ subtopic.name }}</span>
                                            <div style="margin-left: auto;">
                                                <form action="{{ url_for('journey.delete_subtopic', subtopic_id=subtopic.id) }}" method="POST" style="display: inline; margin: 0;" onsubmit="return confirm('Are you sure you want to delete this subtopic? This cannot be undone.');">
                                                    {{ form.hidden_tag() }}
                                                    <button type="submit" class="delete-btn" title="Delete subtopic" onclick="event.stopPropagation();">🗑️</button>
                                                </form>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% else %}
                            <div class="no-subtopics collapsed">No subtopics yet. Click + to add.</div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Add Subject & Syllabus Section -->
        <div class="add-section">
            <button id="showAddFormBtn" class="add-button">
                <span class="add-icon">+</span> Add New Subject or Syllabus
            </button>
            
            <div id="addFormModal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Add Subject or Syllabus</h3>
                        <button type="button" id="close-button" class="close-button">&times;</button>
                    </div>
                    <div class="modal-tabs">
                        <button type="button" id="subject-tab" class="tab-button active">Subject</button>
                        <button type="button" id="syllabus-tab" class="tab-button">Syllabus Topic</button>
                        <button type="button" id="subtopic-tab" class="tab-button">Subtopic</button>
                    </div>
                    <div class="tab-content" id="subject-content">
                        <form id="subject-form" action="{{ url_for('journey.add_subject') }}" method="POST" class="modal-form">
                            {{ form.hidden_tag() }}
                            <div class="form-group">
                                <label for="subject-name">Subject Name:</label>
                                <input type="text" id="subject-name" name="subject_name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="subject-description">Description (Optional):</label>
                                <textarea id="subject-description" name="subject_description" class="form-control" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary form-submit">
                                    <i class="fas fa-plus-circle"></i> Add Subject
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="tab-content hidden" id="syllabus-content">
                        <form id="syllabus-form" action="{{ url_for('journey.add_topic') }}" method="POST" class="modal-form">
                            {{ form.hidden_tag() }}
                            <div class="form-group">
                                <label for="subject-select">Select Subject:</label>
                                <select id="subject-select" name="subject_id" class="form-control" required>
                                    <option value="0">-- Select a subject --</option>
                                    {% for subject in subjects %}
                                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="topic-names">Add Multiple Topics (one per line):</label>
                                <textarea id="topic-names" name="topic_names" class="form-control" rows="6" placeholder="Enter each topic on a new line:&#10;Topic 1&#10;Topic 2&#10;Topic 3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="topic-description">Description for all topics (Optional):</label>
                                <textarea id="topic-description" name="topic_description" class="form-control" rows="3" placeholder="This description will be applied to all topics added above."></textarea>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary form-submit">
                                    <i class="fas fa-plus-circle"></i> Add Topics
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="tab-content hidden" id="subtopic-content">
                        <form id="subtopic-form" action="{{ url_for('journey.add_subtopic') }}" method="POST" class="modal-form">
                            {{ form.hidden_tag() }}
                            <div class="form-group">
                                <label for="topic-select">Select Topic:</label>
                                <select id="topic-select" name="topic_id" class="form-control" required>
                                    <option value="0">-- Select a topic --</option>
                                    {% for subject in subjects %}
                                        <optgroup label="{{ subject.name }}">
                                        {% for topic in subject.topics %}
                                            <option value="{{ topic.id }}">{{ topic.name }}</option>
                                        {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="subtopic-names">Add Multiple Subtopics (one per line):</label>
                                <textarea id="subtopic-names" name="subtopic_names" class="form-control" rows="6" placeholder="Enter each subtopic on a new line:&#10;Subtopic 1&#10;Subtopic 2&#10;Subtopic 3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="subtopic-description">Description for all subtopics (Optional):</label>
                                <textarea id="subtopic-description" name="subtopic_description" class="form-control" rows="3" placeholder="This description will be applied to all subtopics added above."></textarea>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary form-submit">
                                    <i class="fas fa-plus-circle"></i> Add Subtopics
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Study Hours Section -->
        <div class="study-section">
            <h2 class="study-section-title">Daily Study Tracker</h2>
            
            <div class="study-grid">
                <div class="study-form">
                    <div class="form-title">Log Your Study Hours</div>
                    <form id="studyForm" action="{{ url_for('journey.record_study') }}" method="POST">
                        {{ form.hidden_tag() }}
                        <div class="form-group">
                            <label class="form-label" for="studyDate">Date</label>
                            <input type="date" id="studyDate" name="date" class="form-input" required value="{{ now.strftime('%Y-%m-%d') }}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="studyHours">Hours Studied</label>
                            <input type="number" id="studyHours" name="hours" class="form-input" step="0.5" min="0.5" max="12" required placeholder="e.g. 2.5">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="studyNotes">Notes (optional)</label>
                            <textarea id="studyNotes" name="notes" class="form-input" rows="3" placeholder="What did you study today?"></textarea>
                        </div>
                        
                        <button type="submit" class="form-submit">Record Study Session</button>
                    </form>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Study Progress</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" data-view="weekly">Weekly</button>
                            <button class="chart-btn" data-view="monthly">Monthly</button>
                            <button class="chart-btn" data-view="yearly">Yearly</button>
                        </div>
                    </div>
                    <div class="month-nav" style="display: none;">
                        <button class="month-nav-btn prev-month">&larr; Prev</button>
                        <span class="current-month-display"></span>
                        <button class="month-nav-btn next-month">Next &rarr;</button>
                    </div>
                    <canvas id="studyChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
<script>
    // Add notification function if it doesn't exist
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Auto-remove after animation completes
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 4000);
    }
    
    // Add missing functions for syllabus toggling
    function toggleSyllabus(header) {
        const list = header.nextElementSibling;
        header.classList.toggle('collapsed');
        list.classList.toggle('collapsed');
        
        // Update the toggle icon based on collapsed state
        const toggleIcon = header.querySelector('.syllabus-toggle');
        if (toggleIcon) {
            toggleIcon.textContent = header.classList.contains('collapsed') ? '▶' : '▼';
        }
    }
    
    function toggleSubtopicsDropdown(toggleBtn, event) {
        event.stopPropagation();
        const topicItem = toggleBtn.closest('.syllabus-item');
        const subtopicsWrapper = topicItem.querySelector('.subtopics-wrapper') || topicItem.querySelector('.no-subtopics');
        
        if (subtopicsWrapper) {
            subtopicsWrapper.classList.toggle('collapsed');
            toggleBtn.textContent = subtopicsWrapper.classList.contains('collapsed') ? '▶' : '▼';
        }
    }
    
    function showAddSubtopicModal(topicId, topicName, event) {
        // Prevent event propagation to avoid toggling the syllabus
        if (event) {
            event.stopPropagation();
        }
        
        // Show the modal
        document.getElementById('addFormModal').classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Switch to subtopic tab
        document.getElementById('subtopic-tab').click();
        
        // Select the topic in the dropdown
        const topicSelect = document.getElementById('topic-select');
        
        // Loop through all options to find the matching topic
        let found = false;
        for (let i = 0; i < topicSelect.options.length; i++) {
            if (topicSelect.options[i].value === topicId) {
                topicSelect.selectedIndex = i;
                found = true;
                break;
            }
        }
        
        // If not found by direct match, try converting to string and comparing
        if (!found) {
            for (let i = 0; i < topicSelect.options.length; i++) {
                if (String(topicSelect.options[i].value) === String(topicId)) {
                    topicSelect.selectedIndex = i;
                    break;
                }
            }
        }
        
        // Focus on the subtopic names textarea
        document.getElementById('subtopic-names').focus();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the study hours chart
        initializeChart();
        
        // Current selected month and year for monthly and yearly views
        window.currentViewMonth = new Date().getMonth();
        window.currentViewYear = new Date().getFullYear();
        
        // Add event listeners for chart view buttons
        document.querySelectorAll('.chart-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Toggle month navigation display based on view
                const monthNav = document.querySelector('.month-nav');
                if (this.dataset.view === 'monthly') {
                    monthNav.style.display = 'flex';
                    // Update current month display
                    updateCurrentMonthDisplay();
                } else {
                    monthNav.style.display = 'none';
                }
                
                // Fetch data for the selected view
                fetchChartData(this.dataset.view);
            });
        });
        
        // Add event listeners for month navigation
        document.querySelector('.prev-month').addEventListener('click', function() {
            navigateMonth(-1);
        });
        
        document.querySelector('.next-month').addEventListener('click', function() {
            navigateMonth(1);
        });
        
        // Add click handlers for topic checkboxes
        document.querySelectorAll('.syllabus-item .syllabus-checkbox').forEach(checkbox => {
            checkbox.addEventListener('click', function(e) {
                e.preventDefault();
                const topicId = this.dataset.topicId;
                const listItem = this.closest('.syllabus-item');
                const isCompleted = this.getAttribute('data-completed') === 'true';
                
                // If topic is already completed, prevent unchecking
                if (isCompleted) {
                    showNotification('Completed topics cannot be unchecked. Progress can only move forward.', 'warning');
                    return;
                }
                
                // Show temporary visual indication
                this.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
                
                // Create CSRF token
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                
                // Setup the URL for the toggle_topic endpoint
                const toggleTopicUrl = '{{ url_for("journey.toggle_topic", topic_id=0) }}';
                const url = toggleTopicUrl.slice(0, -1) + topicId;
                
                console.log(`Toggling topic ${topicId} to completed state: ${!isCompleted}`);
                
                // Send AJAX request
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        topic_id: topicId,
                        is_completed: !isCompleted
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server returned status ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    
                    // Clear temporary indicator
                    this.style.backgroundColor = '';
                    
                    if (data.success) {
                        // Update checkbox and list item
                        if (data.is_completed) {
                            listItem.classList.add('completed');
                            this.setAttribute('data-completed', 'true');
                        } else {
                            listItem.classList.remove('completed');
                            this.setAttribute('data-completed', 'false');
                        }
                        
                        // Update progress bar
                        const subjectCard = listItem.closest('.subject-card');
                        const progressBar = subjectCard.querySelector('.subject-progress-bar');
                        const progressText = subjectCard.querySelector('.subject-progress-text');
                        
                        progressBar.style.width = `${data.progress}%`;
                        progressText.textContent = `${data.progress}% Complete`;
                        
                        // Update topic progress bar if it exists
                        const topicProgressBar = listItem.querySelector('.topic-progress-bar');
                        if (topicProgressBar) {
                            topicProgressBar.style.width = `${data.topic_progress}%`;
                        }
                        
                        // Update XP display if user_xp is in the response
                        if (data.user_xp !== undefined) {
                            const userXp = document.querySelector('#user-xp');
                            if (userXp) {
                                userXp.textContent = data.user_xp;
                            }
                            
                            // Update level if it was sent
                            if (data.level !== undefined) {
                                const userLevel = document.querySelector('#user-level');
                                if (userLevel) {
                                    userLevel.textContent = data.level;
                                }
                            }
                            
                            // Update remaining XP if available
                            if (data.xp_to_next !== undefined) {
                                const xpRemaining = document.querySelector('#xp-remaining');
                                if (xpRemaining) {
                                    xpRemaining.textContent = data.xp_to_next - data.user_xp;
                                }
                            }
                        }
                        
                        // Handle level up if it occurred
                        if (data.level_up) {
                            showNotification(`Congratulations! You've leveled up to level ${data.level}!`, 'success');
                        }
                        
                        // Show notification
                        if (data.message) {
                            showNotification(data.message, 'success');
                        }
                    } else {
                        showNotification(data.message || 'An error occurred', 'error');
                    }
                })
                .catch(error => {
                    // Clear temporary indicator
                    this.style.backgroundColor = '';
                    console.error('Error:', error);
                    showNotification('An error occurred while updating the topic: ' + error.message, 'error');
                });
            });
        });
        
        // Modal functionality
        const addButton = document.getElementById('showAddFormBtn');
        const modalOverlay = document.getElementById('addFormModal');
        const closeButton = document.getElementById('close-button');
        const subjectTabBtn = document.getElementById('subject-tab');
        const syllabusTabBtn = document.getElementById('syllabus-tab');
        const subtopicTabBtn = document.getElementById('subtopic-tab');
        const subjectContent = document.getElementById('subject-content');
        const syllabusContent = document.getElementById('syllabus-content');
        const subtopicContent = document.getElementById('subtopic-content');
        
        // Open modal
        addButton.addEventListener('click', function() {
            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        });
        
        // Close modal
        closeButton.addEventListener('click', function() {
            modalOverlay.classList.remove('active');
            document.body.style.overflow = '';
        });
        
        // Close modal when clicking outside
        modalOverlay.addEventListener('click', function(e) {
            if (e.target === modalOverlay) {
                modalOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
        
        // Tab switching
        subjectTabBtn.addEventListener('click', function() {
            subjectTabBtn.classList.add('active');
            syllabusTabBtn.classList.remove('active');
            subtopicTabBtn.classList.remove('active');
            subjectContent.classList.remove('hidden');
            syllabusContent.classList.add('hidden');
            subtopicContent.classList.add('hidden');
        });
        
        syllabusTabBtn.addEventListener('click', function() {
            syllabusTabBtn.classList.add('active');
            subjectTabBtn.classList.remove('active');
            subtopicTabBtn.classList.remove('active');
            syllabusContent.classList.remove('hidden');
            subjectContent.classList.add('hidden');
            subtopicContent.classList.add('hidden');
        });
        
        subtopicTabBtn.addEventListener('click', function() {
            subtopicTabBtn.classList.add('active');
            subjectTabBtn.classList.remove('active');
            syllabusTabBtn.classList.remove('active');
            subtopicContent.classList.remove('hidden');
            subjectContent.classList.add('hidden');
            syllabusContent.classList.add('hidden');
        });
        
        // Initialize all syllabus headers to be collapsed by default
        document.querySelectorAll('.syllabus-header').forEach(header => {
            // Toggle to collapse
            const list = header.nextElementSibling;
            header.classList.add('collapsed');
            list.classList.add('collapsed');
            
            // Update the toggle icon to show collapsed state
            const toggleIcon = header.querySelector('.syllabus-toggle');
            if (toggleIcon) {
                toggleIcon.textContent = '▶';
            }
        });
        
        // Initialize all subtopic containers as collapsed
        document.querySelectorAll('.toggle-subtopics-btn').forEach(btn => {
            // Set the text to collapsed state icon
            btn.textContent = '▶';
            
            // Ensure all containers are collapsed initially
            const topicItem = btn.closest('.syllabus-item');
            const wrapper = topicItem.querySelector('.subtopics-wrapper');
            const noSubtopics = topicItem.querySelector('.no-subtopics');
            
            if (wrapper) wrapper.classList.add('collapsed');
            if (noSubtopics) noSubtopics.classList.add('collapsed');
        });
    });
    
    function toggleSubtopic(subtopicId, checkbox, event) {
        event.stopPropagation();
        
        const listItem = checkbox.closest('.subtopic-item');
        const isCompleted = checkbox.getAttribute('data-completed') === 'true';
        
        // If subtopic is already completed, prevent unchecking
        if (isCompleted) {
            showNotification('Completed subtopics cannot be unchecked. Progress can only move forward.', 'warning');
            return;
        }
        
        // Show a temporary visual indicator
        checkbox.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
        
        // Create CSRF token
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        
        // Setup the URL for the toggle_subtopic endpoint
        const toggleSubtopicUrl = '{{ url_for("journey.toggle_subtopic", subtopic_id=0) }}';
        const url = toggleSubtopicUrl.slice(0, -1) + subtopicId;
        
        console.log(`Toggling subtopic ${subtopicId} to completed state: ${!isCompleted}`);
        
        // Send AJAX request
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                subtopic_id: subtopicId,
                is_completed: !isCompleted
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server returned status ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            
            if (data.success) {
                // Clear temporary indicator
                checkbox.style.backgroundColor = '';
                
                // Toggle completed class for the subtopic
                if (data.is_completed) {
                    listItem.classList.add('completed');
                    checkbox.setAttribute('data-completed', 'true');
                } else {
                    listItem.classList.remove('completed');
                    checkbox.setAttribute('data-completed', 'false');
                }
                
                // Update topic progress bar
                const topicItem = listItem.closest('.syllabus-item');
                const topicProgressBar = topicItem.querySelector('.topic-progress-bar');
                if (topicProgressBar) {
                    topicProgressBar.style.width = `${data.topic_progress}%`;
                }
                
                // Check if the topic should be marked as completed (from the server response)
                if (data.topic_is_completed) {
                    topicItem.classList.add('completed');
                    const topicCheckbox = topicItem.querySelector('.syllabus-checkbox');
                    if (topicCheckbox) {
                        topicCheckbox.setAttribute('data-completed', 'true');
                    }
                } else {
                    topicItem.classList.remove('completed');
                    const topicCheckbox = topicItem.querySelector('.syllabus-checkbox');
                    if (topicCheckbox) {
                        topicCheckbox.setAttribute('data-completed', 'false');
                    }
                }
                
                // Update subject progress
                const subjectCard = topicItem.closest('.subject-card');
                const subjectProgressBar = subjectCard.querySelector('.subject-progress-bar');
                const subjectProgressText = subjectCard.querySelector('.subject-progress-text');
                
                if (subjectProgressBar) {
                    subjectProgressBar.style.width = `${data.subject_progress}%`;
                }
                if (subjectProgressText) {
                    subjectProgressText.textContent = `${data.subject_progress}% Complete`;
                }
                
                // Update XP display if user_xp is in the response
                if (data.user_xp !== undefined) {
                    const userXp = document.querySelector('#user-xp');
                    if (userXp) {
                        userXp.textContent = data.user_xp;
                    }
                    
                    // Update level if it was sent
                    if (data.level !== undefined) {
                        const userLevel = document.querySelector('#user-level');
                        if (userLevel) {
                            userLevel.textContent = data.level;
                        }
                    }
                    
                    // Update remaining XP if available
                    if (data.xp_to_next !== undefined) {
                        const xpRemaining = document.querySelector('#xp-remaining');
                        if (xpRemaining) {
                            xpRemaining.textContent = data.xp_to_next - data.user_xp;
                        }
                    }
                }
                
                // Handle level up if it occurred
                if (data.level_up) {
                    showNotification(`Congratulations! You've leveled up to level ${data.level}!`, 'success');
                }
                
                // Show notification
                if (data.message) {
                    showNotification(data.message, data.is_completed ? 'success' : 'info');
                }
            } else {
                // Clear temporary indicator
                checkbox.style.backgroundColor = '';
                showNotification(data.message || 'An error occurred', 'error');
            }
        })
        .catch(error => {
            // Clear temporary indicator
            checkbox.style.backgroundColor = '';
            console.error('Error:', error);
            showNotification('An error occurred while updating the subtopic: ' + error.message, 'error');
        });
    }
    
    // Chart functions
    let studyChart = null;

    function initializeChart() {
        const ctx = document.getElementById('studyChart').getContext('2d');
        
        // Chart.js configuration for the study hours chart
        studyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Hours Studied',
                    data: [],
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(99, 102, 241, 0.8)',
                    barPercentage: 0.7,
                    categoryPercentage: 0.8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1500,
                    easing: 'easeOutQuart'
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 10,
                        bottom: 30  // Added significant bottom padding
                    }
                },
                plugins: {
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleColor: 'rgba(255, 255, 255, 0.9)',
                        bodyColor: 'rgba(255, 255, 255, 0.9)',
                        borderColor: 'rgba(59, 130, 246, 0.5)',
                        borderWidth: 1,
                        padding: 10,
                        cornerRadius: 6,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                let hours = context.raw;
                                return `${hours} ${hours === 1 ? 'hour' : 'hours'} studied`;
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            font: {
                                size: 14
                            },
                            padding: 8,
                            callback: function(value) {
                                return value + 'h';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            font: {
                                size: 14
                            },
                            padding: 8,
                            autoSkip: false,  // Never skip labels by default
                            maxRotation: 0,   // No rotation by default
                            minRotation: 0,
                            autoSkipPadding: 10, // Keep some spacing between labels
                            align: 'center'
                        }
                    }
                }
            }
        });
        
        // Fetch initial data (default to weekly view)
        fetchChartData('weekly');
    }

    function fetchChartData(view) {
        // Add loading state to chart container
        const chartContainer = document.querySelector('.chart-container');
        chartContainer.classList.add('loading');
        
        // Create CSRF token
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        
        // Create request data based on view
        let requestData = { view };
        
        // Add month and year parameters for monthly view
        if (view === 'monthly') {
            requestData.month = window.currentViewMonth + 1; // API expects 1-based month
            requestData.year = window.currentViewYear;
        } else if (view === 'yearly') {
            // Add year parameter for yearly view
            requestData.year = window.currentViewYear;
        }
        
        console.log(`Fetching ${view} data with params:`, requestData);
        
        // Fetch data from API
        fetch('{{ url_for("journey.get_study_hours") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            // Remove loading state
            chartContainer.classList.remove('loading');
            
            if (data.success) {
                // Store month name for monthly view
                if (view === 'monthly' && data.month) {
                    window.lastFetchedMonthName = data.month;
                    
                    // Update current month display in the navigation
                    const monthDisplay = document.querySelector('.current-month-display');
                    if (monthDisplay) {
                        monthDisplay.textContent = data.month;
                    }
                    
                    // Update stored month and year for navigation
                    if (data.month_number && data.year) {
                        window.currentViewMonth = data.month_number - 1; // Store as 0-based
                        window.currentViewYear = data.year;
                    }
                }
                
                updateChart(data.labels, data.data, view);
            } else {
                showNotification(data.message || 'Error loading chart data', 'error');
            }
        })
        .catch(error => {
            // Remove loading state
            chartContainer.classList.remove('loading');
            console.error('Error:', error);
            showNotification('Failed to load chart data: ' + error.message, 'error');
        });
    }

    function updateChart(labels, data, view) {
        // If there's no data, show a message
        if (!data.length) {
            if (!document.querySelector('.no-data-message')) {
                const message = document.createElement('div');
                message.className = 'no-data-message';
                message.textContent = 'No study data recorded yet. Log your study hours to see your progress!';
                document.querySelector('.chart-container').appendChild(message);
            }
            
            // Hide the chart if it exists
            if (studyChart) {
                document.getElementById('studyChart').style.display = 'none';
            }
            return;
        }
        
        // Remove no-data message if it exists
        const noDataMessage = document.querySelector('.no-data-message');
        if (noDataMessage) {
            noDataMessage.remove();
        }
        
        // Show the chart
        document.getElementById('studyChart').style.display = 'block';
        
        // Initialize the chart if it doesn't exist
        if (!studyChart) {
            initializeChart();
        }
        
        // Set chart title based on view
        let title;
        switch (view) {
            case 'weekly':
                title = 'Weekly Study Hours';
                break;
            case 'monthly':
                title = 'Daily Study Hours';
                break;
            case 'yearly':
                title = 'Yearly Study Hours';
                break;
            default:
                title = 'Study Hours';
        }
        
        // Update chart data
        studyChart.data.labels = labels;
        studyChart.data.datasets[0].data = data;
        studyChart.data.datasets[0].label = title;
        
        // Configure view-specific options
        if (view === 'weekly') {
            // Hide month navigation for weekly view
            const monthNav = document.querySelector('.month-nav');
            monthNav.style.display = 'none';
            
            // For weekly view, make sure all 7 days are shown and rotate labels for better readability
            studyChart.options.scales.x.ticks.autoSkip = false;
            studyChart.options.scales.x.ticks.maxTicksLimit = 7; // Force 7 ticks for the 7 days
            studyChart.options.scales.x.ticks.maxRotation = 45;
            studyChart.options.scales.x.ticks.minRotation = 45;
            
            // Add bottom padding to accommodate rotated labels
            studyChart.options.layout.padding = {
                left: 10,
                right: 10,
                top: 10,
                bottom: 50
            };
            
            // Update chart title
            const chartTitle = document.querySelector('.chart-title');
            if (chartTitle) {
                chartTitle.textContent = 'Study Progress';
            }
        } else if (view === 'monthly') {
            // Show month navigation for monthly view
            const monthNav = document.querySelector('.month-nav');
            monthNav.style.display = 'flex';
            
            // No rotation for monthly view
            studyChart.options.scales.x.ticks.maxRotation = 0;
            studyChart.options.scales.x.ticks.minRotation = 0;
            studyChart.options.scales.x.ticks.padding = 8;
            
            // Reset padding
            studyChart.options.layout.padding = {
                left: 10,
                right: 10,
                top: 10,
                bottom: 30
            };
            
            // For monthly view, ensure all days are shown without skipping
            studyChart.options.scales.x.ticks.autoSkip = false;
            
            // Dynamically adjust bar size based on number of days
            // The more days, the narrower the bars
            if (labels.length >= 30) {
                studyChart.data.datasets[0].barPercentage = 0.4; // Narrower for 31 days
                studyChart.data.datasets[0].categoryPercentage = 0.8;
            } else if (labels.length >= 20) {
                studyChart.data.datasets[0].barPercentage = 0.5; // Medium for ~30 days
                studyChart.data.datasets[0].categoryPercentage = 0.85;
            } else {
                studyChart.data.datasets[0].barPercentage = 0.6; // Wider for fewer days
                studyChart.data.datasets[0].categoryPercentage = 0.9;
            }
            
            // Update chart title to include month name if available
            const chartTitle = document.querySelector('.chart-title');
            if (chartTitle) {
                const monthName = window.lastFetchedMonthName || 'Monthly View';
                chartTitle.textContent = monthName;
            }
        } else if (view === 'yearly') {
            // Show month navigation for yearly view (for year navigation)
            const monthNav = document.querySelector('.month-nav');
            monthNav.style.display = 'flex';
            
            // Reset rotation for yearly view
            studyChart.options.scales.x.ticks.maxRotation = 0;
            studyChart.options.scales.x.ticks.minRotation = 0;
            studyChart.options.scales.x.ticks.padding = 15;
            
            // Reset padding
            studyChart.options.layout.padding = {
                left: 10,
                right: 10,
                top: 10,
                bottom: 30
            };
            
            // For yearly view, show all labels (12 months)
            studyChart.options.scales.x.ticks.autoSkip = false;
            studyChart.options.scales.x.ticks.maxTicksLimit = 12;
            
            // Adjust bar size for monthly data
            studyChart.data.datasets[0].barPercentage = 0.6;
            studyChart.data.datasets[0].categoryPercentage = 0.8;
            
            // Update navigation display to show current year
            updateYearDisplay();
            
            // Update chart title to include year
            const chartTitle = document.querySelector('.chart-title');
            if (chartTitle) {
                chartTitle.textContent = `${window.currentViewYear} Monthly Study Hours`;
            }
        }
        
        // Update the chart
        studyChart.update();
    }
    
    function updateCurrentMonthDisplay() {
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
        const display = document.querySelector('.current-month-display');
        if (display) {
            display.textContent = `${monthNames[window.currentViewMonth]} ${window.currentViewYear}`;
        }
    }
    
    function updateYearDisplay() {
        const display = document.querySelector('.current-month-display');
        if (display) {
            display.textContent = `${window.currentViewYear}`;
        }
    }

    function navigateMonth(direction) {
        // Get the current active view
        const activeView = document.querySelector('.chart-btn.active').dataset.view;
        
        if (activeView === 'yearly') {
            // For yearly view, just navigate years
            window.currentViewYear += direction;
            
            // Update display
            updateYearDisplay();
            
            // Fetch data for the new year
            fetchChartData('yearly');
        } else {
            // For monthly view, navigate months
            // Calculate new month and year
            let newMonth = window.currentViewMonth + direction;
            let newYear = window.currentViewYear;
            
            // Handle year change
            if (newMonth < 0) {
                newMonth = 11; // December
                newYear--;
            } else if (newMonth > 11) {
                newMonth = 0;  // January
                newYear++;
            }
            
            // Update stored values
            window.currentViewMonth = newMonth;
            window.currentViewYear = newYear;
            
            // Update display
            updateCurrentMonthDisplay();
            
            // Fetch data for the new month
            fetchChartData('monthly');
        }
    }
</script>
{% endblock %}
{% endblock %}